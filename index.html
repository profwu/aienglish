<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Native AI 英文對話模擬系統 | No-Key Local Coach v2.1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&family=Inter:wght@400;600;800&display=swap');
    body { font-family:'Inter','Noto Sans TC',sans-serif; background:#f8fafc; overflow-x:hidden; -webkit-tap-highlight-color:transparent; }
    .glass-panel { background:rgba(255,255,255,.95); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,.5); }
    .custom-scrollbar::-webkit-scrollbar{width:4px}
    .custom-scrollbar::-webkit-scrollbar-thumb{background:#e2e8f0;border-radius:10px}
    .recording-pulse{animation:pulse 1.5s infinite}
    @keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(239,68,68,.4)}70%{transform:scale(1.05);box-shadow:0 0 0 15px rgba(239,68,68,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(239,68,68,0)}}
    .audio-bar{transition:height .1s ease;min-height:4px}
    .advice-bubble{background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);border:1px dashed #4ade80}
    .scenario-card:hover{transform:translateY(-2px);transition:all .2s}
    .pill{font-size:10px;font-weight:900;letter-spacing:.12em}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>

<body class="p-2 md:p-6 min-h-screen flex flex-col bg-slate-50">

  <!-- Header -->
  <header class="mb-4 bg-white p-4 md:p-5 rounded-[2rem] shadow-sm border-b-4 border-indigo-600">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
      <div>
        <h1 class="text-lg md:text-xl font-black text-slate-800 tracking-tight flex items-center gap-2">
          <i class="fa-solid fa-bolt text-indigo-600"></i> Native 英文對話教練
        </h1>
        <p class="text-[10px] md:text-xs text-slate-400 font-bold mt-0.5">GitHub Pages 免 Key｜Local Coach v2.1</p>
      </div>
      <div id="status-badge"
           class="px-4 py-1.5 bg-emerald-50 text-emerald-600 rounded-full text-[10px] font-black tracking-widest border border-emerald-100 shadow-sm transition-all whitespace-nowrap">
        READY
      </div>
    </div>
  </header>

  <!-- Main -->
  <div class="grid grid-cols-12 gap-4 flex-grow">

    <!-- Left: Metrics -->
    <div class="col-span-12 lg:col-span-3 order-3 lg:order-1 flex flex-col gap-4">
      <div class="glass-panel p-5 rounded-[2.5rem] shadow-xl flex-grow flex flex-col border-t-4 border-indigo-600">
        <h2 class="text-xs font-black mb-5 flex items-center gap-2 text-indigo-700 uppercase tracking-wider">
          <i class="fa-solid fa-gauge-high"></i> Rubric Dashboard
        </h2>

        <div class="space-y-6">
          <div class="bg-indigo-50/50 p-4 rounded-3xl border border-indigo-100/50">
            <div class="flex justify-between items-end mb-2">
              <span class="text-slate-500 text-[10px] font-black uppercase">Overall Score</span>
              <span id="score-val" class="text-indigo-600 font-black text-2xl">--</span>
            </div>
            <div class="w-full bg-indigo-100 rounded-full h-2.5 overflow-hidden">
              <div id="score-bar" class="bg-indigo-500 h-full transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-3">
              <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Fluency</div>
              <div class="text-lg font-black text-slate-800" id="r-fluency">--</div>
            </div>
            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-3">
              <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Accuracy</div>
              <div class="text-lg font-black text-slate-800" id="r-accuracy">--</div>
            </div>
            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-3">
              <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Vocabulary</div>
              <div class="text-lg font-black text-slate-800" id="r-vocab">--</div>
            </div>
            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-3">
              <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Coherence</div>
              <div class="text-lg font-black text-slate-800" id="r-coh">--</div>
            </div>
          </div>

          <div class="space-y-5">
            <div class="px-1">
              <div class="flex justify-between text-[11px] mb-1.5">
                <span class="text-slate-400 font-bold uppercase">Speed (WPM)</span>
                <span id="pace-tag" class="text-blue-500 font-black">---</span>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex-grow h-2 bg-slate-100 rounded-full overflow-hidden">
                  <div id="pace-bar" class="bg-blue-400 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="pace-val" class="text-[10px] font-black text-slate-600 w-10 text-right">0</span>
              </div>
            </div>

            <div class="px-1">
              <div class="flex justify-between text-[11px] mb-1.5">
                <span class="text-slate-400 font-bold uppercase">Filler Words</span>
                <span id="filler-tag" class="text-amber-500 font-black">None</span>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex-grow h-2 bg-slate-100 rounded-full overflow-hidden">
                  <div id="filler-bar" class="bg-amber-400 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="filler-val" class="text-[10px] font-black text-slate-600 w-10 text-right">0</span>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between p-4 bg-white rounded-3xl border border-slate-100 shadow-sm">
            <div class="flex items-center gap-3">
              <div id="performance-icon" class="text-3xl transition-all duration-500">🎯</div>
              <div>
                <span class="text-slate-400 text-[10px] font-black block uppercase tracking-wider">Level</span>
                <span id="performance-val" class="text-slate-700 font-bold text-sm">Waiting...</span>
              </div>
            </div>
          </div>

          <div class="pt-2">
            <div class="flex items-end justify-center gap-1.5 h-12" id="visualizer">
              <div class="audio-bar w-1.5 bg-indigo-200 rounded-full h-1"></div>
              <div class="audio-bar w-1.5 bg-indigo-300 rounded-full h-1"></div>
              <div class="audio-bar w-1.5 bg-indigo-400 rounded-full h-1"></div>
              <div class="audio-bar w-1.5 bg-indigo-500 rounded-full h-1"></div>
              <div class="audio-bar w-1.5 bg-indigo-400 rounded-full h-1"></div>
              <div class="audio-bar w-1.5 bg-indigo-300 rounded-full h-1"></div>
              <div class="audio-bar w-1.5 bg-indigo-200 rounded-full h-1"></div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Center: Chat -->
    <div class="col-span-12 lg:col-span-6 order-1 lg:order-2 flex flex-col gap-4">
      <div class="glass-panel rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[420px] md:h-[560px] border-2 border-white">
        <div class="bg-white/70 backdrop-blur p-4 border-b border-slate-100 flex justify-between items-center px-6">
          <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">
            <span class="w-2 h-2 bg-emerald-500 rounded-full"></span> Local Coach Engine
          </span>
          <div class="flex items-center gap-2">
            <button id="tts-btn-main" onclick="speakLastAI()" class="hidden w-8 h-8 flex items-center justify-center bg-indigo-50 rounded-full text-indigo-600 hover:bg-indigo-100 transition">
              <i class="fa-solid fa-volume-high text-xs"></i>
            </button>
            <button id="copy-btn" onclick="copyLastReport()" class="hidden w-8 h-8 flex items-center justify-center bg-slate-50 rounded-full text-slate-600 hover:bg-slate-100 transition" title="Copy report">
              <i class="fa-regular fa-copy text-xs"></i>
            </button>
          </div>
        </div>

        <div id="chat-container" class="flex-grow p-4 md:p-6 overflow-y-auto custom-scrollbar flex flex-col gap-4 bg-slate-50/20">
          <div class="bg-white p-4 rounded-3xl rounded-tl-none max-w-[90%] text-slate-700 shadow-sm border border-slate-100 text-sm leading-relaxed">
            Hello! 這是<strong>純免 Key</strong>版本：改寫/文法解釋/對話教練/評分都在本地執行。請右側選場景，按 Record 開始！
          </div>
        </div>

        <div id="thinking-indicator" class="hidden px-6 py-3 bg-white/50 text-[10px] text-slate-400 font-bold flex items-center gap-2 border-t border-slate-50">
          <i class="fa-solid fa-microchip fa-spin text-indigo-400"></i> 本地引擎分析中...
        </div>
      </div>

      <!-- Controls -->
      <div class="flex justify-center items-center gap-6 md:gap-10 py-2">
        <div class="w-16"></div>

        <button id="record-btn"
                class="w-20 h-20 md:w-28 md:h-28 rounded-full bg-white shadow-2xl border-4 border-indigo-500 flex flex-col items-center justify-center group hover:bg-indigo-50 transition-all duration-300 relative active:scale-95">
          <div id="record-fill" class="absolute inset-0 bg-indigo-500/10 scale-0 rounded-full transition-transform duration-300"></div>
          <i id="record-icon" class="fa-solid fa-microphone text-2xl md:text-4xl text-indigo-500 mb-1 relative z-10"></i>
          <span id="record-text" class="text-[9px] font-black text-indigo-500 uppercase relative z-10">Record</span>
        </button>

        <div class="w-16"></div>
      </div>
    </div>

    <!-- Right: Scenarios + Log -->
    <div class="col-span-12 lg:col-span-3 order-2 lg:order-3 flex flex-col gap-4">

      <div class="glass-panel p-5 rounded-[2.5rem] shadow-xl border-t-4 border-emerald-500 flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xs font-black text-emerald-700 flex items-center gap-2 uppercase tracking-wider">
            <i class="fa-solid fa-list-check"></i> Practice Scenarios
          </h2>
        </div>
        <div id="question-list" class="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar"></div>
      </div>

      <div class="glass-panel p-5 rounded-[2.5rem] shadow-xl flex-grow border-t-4 border-amber-500 flex flex-col min-h-[120px]">
        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Session Log</h2>
        <div id="history-list" class="text-[11px] space-y-2 overflow-y-auto flex-grow custom-scrollbar">
          <p class="text-slate-300 italic text-center py-4">Waiting for first response...</p>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ----------------------------
    // Local Coach Data
    // ----------------------------
    const SCENARIOS = [
      {
        name: "At a Restaurant",
        emoji: "🍔",
        intents: ["order", "allergy", "table", "pay"],
        questions: [
          "What would you like to order today?",
          "Do you have any food allergies?",
          "Would you like a table for two?"
        ]
      },
      {
        name: "Travel & Airport",
        emoji: "✈️",
        intents: ["passport", "destination", "luggage", "boarding"],
        questions: [
          "Could I see your passport and ticket?",
          "Where are you flying to today?",
          "Do you have any luggage to check in?"
        ]
      },
      {
        name: "Job Interview",
        emoji: "💼",
        intents: ["self", "strength", "weakness", "motivation"],
        questions: [
          "Could you tell me about yourself?",
          "What are your greatest strengths?",
          "Why do you want to work for us?"
        ]
      },
      {
        name: "Daily Greeting",
        emoji: "👋",
        intents: ["day", "weekend", "hobby", "movie"],
        questions: [
          "How was your day so far?",
          "What are your plans for the weekend?",
          "Have you seen any good movies lately?"
        ]
      }
    ];

    // fillers
    const FILLER_WORDS = ["um","uh","err","ah","like","basically","actually","you know","kind of","sort of"];
    const COHERENCE_MARKERS = ["because","so","but","however","therefore","for example","for instance","first","second","finally","in addition","also"];

    // Advanced adjective suggestions
    const ADJ_UPGRADE = [
      { from: /\bgood\b/ig, to: "great / excellent / fantastic" },
      { from: /\bbad\b/ig, to: "unpleasant / poor / subpar" },
      { from: /\bvery\b/ig, to: "really / extremely / highly" },
      { from: /\bnice\b/ig, to: "pleasant / lovely" }
    ];

    // Pattern-based rewrites (safe, deterministic)
    const REWRITE_RULES = [
      { id: "polite_request", title:"更禮貌的請求", pattern:/\bI want\b/ig, replace:"I would like" , explain:"在服務情境中，I would like 比 I want 更禮貌。"},
      { id: "opinion", title:"更正式的表達看法", pattern:/\bI think\b/ig, replace:"In my opinion" , explain:"In my opinion 較正式，適合面試/正式對話。"},
      { id: "because_start", title:"避免因為開頭太口語", pattern:/^Because\s+/i, replace:"This is because " , explain:"用 This is because 讓句子更完整。"},
      { id: "and_overuse", title:"減少 And 的重複", pattern:/\band\b/ig, replace:"and (or: in addition / furthermore)" , explain:"連接詞多樣化能提升 coherence。"},
    ];

    // Grammar rules (common ESL)
    const GRAMMAR_RULES = [
      {
        id:"a_an",
        title:"a / an 使用",
        detect:(t)=> /\ba\s+[aeiou]/i.test(t) || /\ban\s+[^aeiou\s]/i.test(t),
        fix:(t)=> t
          .replace(/\ba\s+([aeiou])/ig, "an $1")
          .replace(/\ban\s+([^aeiou\s])/ig, "a $1"),
        explain:"a 用在子音開頭音；an 用在母音開頭音（看發音，不是字母）。",
        exampleBad:"a apple / an book",
        exampleGood:"an apple / a book"
      },
      {
        id:"third_person_s",
        title:"第三人稱單數 -s",
        detect:(t)=> /\b(he|she|it)\s+(go|do|have|want|need|like|work|play)\b/i.test(t),
        fix:(t)=> t
          .replace(/\b(he|she|it)\s+go\b/ig, "$1 goes")
          .replace(/\b(he|she|it)\s+do\b/ig, "$1 does")
          .replace(/\b(he|she|it)\s+have\b/ig, "$1 has")
          .replace(/\b(he|she|it)\s+(want|need|like|work|play)\b/ig, "$1 $2s"),
        explain:"現在式第三人稱單數（he/she/it）動詞常加 -s / -es（例外：do→does, have→has）。",
        exampleBad:"He go to work.",
        exampleGood:"He goes to work."
      },
      {
        id:"past_time",
        title:"過去時間搭配過去式",
        detect:(t)=> /\b(yesterday|last\s+night|last\s+week|two\s+days\s+ago)\b/i.test(t) && /\b(am|is|are|go|do|have)\b/i.test(t),
        fix:(t)=> t
          .replace(/\bgo\b/ig, "went")
          .replace(/\bdo\b/ig, "did")
          .replace(/\bhave\b/ig, "had")
          .replace(/\b(am|is)\b/ig, "was")
          .replace(/\bare\b/ig, "were"),
        explain:"句子有明確過去時間（yesterday/last...）時，動詞多用過去式。",
        exampleBad:"Yesterday I go there.",
        exampleGood:"Yesterday I went there."
      }
    ];

    const STATUS_STYLE = {
      emer
